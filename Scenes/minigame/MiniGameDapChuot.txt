local TxtTime, txtDiem, txtExp, txtVang, txtSoLuotChoi
local timer = 0  -- Biến đếm thời gian
local time = 45
local allVitriChuot, objectMat, animChucPhuc
local spriteMatMo, spriteMatNham, spriteBanTayTha, spriteBanTayBop, spriteBanTayCam
LuaBehaviour = LuaBehaviour or {}


local imgVang, imgExp

local XluaNetwork = CS.XluaNetwork();-- tạo instance của class XluaMethod để gọi các hàm không static
local XluaJSONNode = CS.XluaJSONNode();

local oMoiDap = -1

local AllQuai = {}

local animBanTay, ImgBanTay, BtnChoiNgay

local camDapChuot = false
local isPlay = false
local Diem, Vang, Exp = 0, 0, 0
local allGiaKC,maxLuotChoi,soLuotChoi
local BangKetQua, txtKetQua, txtInfo
function start()
    TxtTime = txtTime:GetComponent("Text")
 
    allViTriChuot = ObjDangChoi.transform:Find("allViTri")
    MiniGameDapChuot.allViTriChuot = allViTriChuot  
    MiniGameDapChuot.self = self
    objectMat = self.transform:Find("MatMo"):GetComponent("Image")
    spriteMatMo = objectMat:GetComponent("Image").sprite
    spriteMatNham = self.transform:Find("MatNham"):GetComponent("Image").sprite
    txtDiem = self.transform:GetChild(0).transform:Find("txtDiem"):GetComponent("Text")
    txtSoLuotChoi = self.transform:GetChild(0).transform:Find("txtSoLuotChoi"):GetComponent("Text")
    txtExp = ObjDangChoi.transform:Find("txtExp"):GetComponent("Text")
    txtVang = ObjDangChoi.transform:Find("txtVang"):GetComponent("Text")
    imgVang = ObjDangChoi.transform:Find("imgVang").gameObject
    imgExp = ObjDangChoi.transform:Find("imgExp").gameObject

    animChucPhuc = self.transform:Find("animChucPhuc").gameObject
    local allQuai = self.transform:Find("allQuai")

    spriteBanTayTha = self.transform:Find("imgBanTayTha"):GetComponent("Image").sprite
    spriteBanTayBop = self.transform:Find("imgBanTayBop"):GetComponent("Image").sprite
    spriteBanTayCam = self.transform:Find("imgBanTayCam"):GetComponent("Image").sprite
    ImgBanTay = ObjDangChoi.transform:Find("BanTay"):GetComponent("Image")
    animBanTay = ImgBanTay.gameObject:GetComponent("Animator")
    BtnChoiNgay = ObjChuaChoi.transform:Find("btnChoiNgay"):GetComponent("Button")

    BangKetQua = ObjChuaChoi.transform:Find("BangKetQua").gameObject
    txtKetQua = BangKetQua.transform:GetChild(0):GetComponent("Text")
    txtInfo = ObjChuaChoi.transform:Find("txtInfo").gameObject

    BtnChoiNgay.onClick:AddListener(ChoiNgay)

    self.transform:GetChild(0).transform:Find("btnExit"):GetComponent("Button").onClick:AddListener(ExitMenu)
    for i = 0, allQuai.transform.childCount -1 do
        local childi = allQuai.transform:GetChild(i)
        AllQuai[childi.name] = childi.gameObject
       end
       ParseData()
      -- print('AllQuai test: '..AllQuai["SocVang"].name)
    end

function SetSoLuotChoi()
    txtSoLuotChoi.text = "Bạn còn <color=lime>"..maxLuotChoi - tonumber(soLuotChoi) .."</color> lượt chơi"
end
function ParseData()
        --print('parse data: '.._G.MiniGameDapChuot.dataParse.data.soluotchoi)
        maxLuotChoi = _G.MiniGameDapChuot.dataParse.maxLuotChoi
        soLuotChoi = tonumber(_G.MiniGameDapChuot.dataParse.data.soluotchoi)
        SetSoLuotChoi()
        allGiaKC = _G.MiniGameDapChuot.dataParse.allGiaKC
       _G.MiniGameDapChuot.dataParse = nil
    --print('gia kc choi lan 2 la: '..allGiaKC["2"])
end
    local isCreate = true;-- được tạo trong 1 giây
function update()
   
    if time >= 0 and isPlay then
        timer = timer + CS.UnityEngine.Time.deltaTime  -- Cộng thời gian mỗi frame
        if timer >= 1 then  -- Nếu đã đủ 1 giây
            TxtTime.text = _G.LuaExtension:FormatTime(time)
            time = time - 1  -- Giảm 1 giây
            timer = 0  -- Reset bộ đếm
            isCreate = true
        elseif timer > 0.85 and isCreate and time > 1 then
            isCreate = false
            local random = math.floor(CS.UnityEngine.Random.Range(3, 6)) 
            for i = 0, random do
                CreateMat()
              end  
        end
    elseif time <= 0 and isPlay then
        TinhKetQua()
        isPlay = false
    end
end

function TinhKetQua()
    ObjChuaChoi:SetActive(true)
    ObjDangChoi:SetActive(false)
    BangKetQua:SetActive(true)
    txtInfo:SetActive(false)
    local strSoDiem = "Số Diểm: <color=lime>".._G.LuaExtension:formatNumber(Diem).."</color>\n"
    local strExp = "Kinh nghiệm: <color=lime>".._G.LuaExtension:formatNumber(Exp).."</color>\n"
    local strVang = "Vàng: <color=yellow>".._G.LuaExtension:formatNumber(Vang).."</color>\n"
    local strEnd = "<color=orange>Kinh nghiệm, vàng và vật phẩm đã được đưa vào hộp quà</color>"
    txtKetQua.text = "                   <size=50><color=yellow>Bảng Kết Quả</color></size>\n"..strSoDiem..strExp..strVang..strEnd
end



function CreateMat()
    local random = math.floor(CS.UnityEngine.Random.Range(0, allViTriChuot.transform.childCount)) 
    if allViTriChuot.transform:GetChild(random).transform.childCount > 0 then
        random = math.floor(CS.UnityEngine.Random.Range(0, allViTriChuot.transform.childCount))  -- random thử thêm 1 lần nữa
        return
    end
 
    if allViTriChuot.transform:GetChild(random).transform.childCount > 0 then return end
    
    --print("random la"..random)
    if oMoiDap == random then oMoiDap = -1 end
    local parent = allViTriChuot.transform:GetChild(random)
    local clone = CS.UnityEngine.Object.Instantiate(objectMat, parent)
    local vector3 = CS.UnityEngine.Vector3(parent.transform.position.x,parent.transform.position.y- 0.1,parent.transform.position.z)
    clone.gameObject:SetActive(true)
    clone.transform.position = vector3

    CS.EventManager.StartDelay2(function ()
            clone:GetComponent("Image").sprite = spriteMatNham
            CS.EventManager.StartDelay2(function ()
                --clone.gameObject:SetActive(false)
                CS.UnityEngine.Object.Destroy(clone.gameObject)
               
              end,0.3)
        end,0.3)
    end




    function MiniGameDapChuot:testcallLua()
        print("call ok roi nha")
    end

    function MiniGameDapChuot:DapChuot(vitri)
        if oMoiDap == vitri or camDapChuot == true then return end
        oMoiDap = vitri
        --print('dap chuot vi tri: '..vitri)

        ImgBanTay.sprite = spriteBanTayBop
       

        local method = 'MiniGameDapChuot'
        local nameClass = 'DapChuot'
        local keyData = { 'key',}
        local valueData = { 'value',}
       
        
        local function callbackDapChuot(response)
            print('call back dap chuot: '.. response)
        
        -- Chuyển đổi JSON thành Lua table
        local L = "return "..response:gsub('("[^"]-"):','[%1]=')  -- Thay dấu ':' bằng '='
        
        -- Sử dụng load thay vì loadstring
        local func = load(L)  -- Đảm bảo rằng load được gọi thay vì loadstring
        
        if func then
            local T = func()  -- Thực thi hàm Lua để nhận bảng Lua
            -- Truy xuất giá trị trong bảng Lua
            --print(T.message)
            if T.status == "0" then
                 --print('allViTriChuot: '..allViTriChuot.name)
                 Diem = Diem + 1
                 SetDiem()
              
                
                local cloneChucPhuc = CS.UnityEngine.Object.Instantiate(animChucPhuc, ObjDangChoi.transform)
                cloneChucPhuc.transform:SetSiblingIndex(2)
                local nameitemroi = T.nameitemroi
                local soluong = T.soluong
                local loai = T.loai
               
                local function RoiItem()
                    local cloneimgItemRoi
                    if loai == "Item" then
                        cloneimgItemRoi = CS.UnityEngine.Object.Instantiate(imgItemRoi, ObjDangChoi.transform)
                        local imgitem = cloneimgItemRoi:GetComponent("Image")
                        imgitem.sprite = CS.Inventory.LoadSprite(nameitemroi)
                        imgitem:SetNativeSize()
                        _G.LuaExtension:ResizeImage(imgitem,70)
                        SetBanTayTha()
                        --print('T.soluong'..soluong)
                        CS.EventManager.StartDelay2(function ()
                            local quabay = imgitem:GetComponent(typeof(CS.QuaBay))
                            if nameitemroi == "Vang" then
                                quabay.vitribay = imgVang.gameObject
                                Vang = Vang + tonumber(soluong)
                                txtVang.text = tostring(_G.LuaExtension:formatNumber(Vang))
                            elseif nameitemroi == "Exp" then 
                                quabay.vitribay = imgExp.gameObject
                                Exp = Exp + tonumber(soluong)
                                txtExp.text = tostring(_G.LuaExtension:formatNumber(Exp))
                            else
                                quabay.vitribay = CS.UnityEngine.GameObject.FindGameObjectWithTag("hopqua")
                            end
                           
                            quabay.enabled = true
                          
                          end,0.3)
                    elseif loai == "Quai" then
                       
                        cloneimgItemRoi = CS.UnityEngine.Object.Instantiate(AllQuai[nameitemroi], ObjDangChoi.transform)
                        CS.UnityEngine.Object.Destroy(cloneimgItemRoi.gameObject,1)
                        if nameitemroi == "XuongRong" then
                            camDapChuot = true
                            ImgBanTay.sprite = spriteBanTayCam
                            ImgBanTay:SetNativeSize()
                            animBanTay.enabled = true
    
                            CS.EventManager.StartDelay2(function ()
                                camDapChuot = false
                                animBanTay.enabled = false
                                ImgBanTay.sprite = spriteBanTayTha
                                ImgBanTay:SetNativeSize()
                              end,3)
                        else
                            nameitemroi = T.itemsoc.name
                            soluong = T.itemsoc.soluong
                            loai = T.itemsoc.loai
                            CS.EventManager.StartDelay2(function ()
                                RoiItem()
                              end,1)
                          
                           
                        end
    
                    end
                  
                    cloneimgItemRoi.transform.position = allViTriChuot.transform:GetChild(vitri).transform.position
                    cloneimgItemRoi.gameObject:SetActive(true)
                    cloneChucPhuc.transform.position = allViTriChuot.transform:GetChild(vitri).transform.position
                    cloneChucPhuc:SetActive(true)
                    CS.UnityEngine.Object.Destroy(cloneChucPhuc.gameObject,1)
                end
                RoiItem()

            else
                CS.CrGame.ins:OnThongBaoNhanh(T.message, 2)
            end
        else
            print("Error loading Lua code")
        end
        
        end
        XluaNetwork:SendRequest(method, nameClass, keyData, valueData, callbackDapChuot)
    end

    function SetBanTayTha()
        CS.EventManager.StartDelay2(function ()
            if camDapChuot == false then 
            ImgBanTay.sprite = spriteBanTayTha
            end
          end,0.5)
    end

    local xacNhanChoiNgay = false;
    function ChoiNgay()
        --CS.CrGame.ins:OnThongBaoNhanh("đã ấn play", 2)
        if soLuotChoi < 7 then
            print('soLuotChoi la: '..tostring(soLuotChoi));
            print('kim cuong yeu cau la: '..allGiaKC[tostring(soLuotChoi)]);
            local kcYeuCau = tonumber(allGiaKC[tostring(soLuotChoi)])
         
            if kcYeuCau > 0 and xacNhanChoiNgay == false then
                CS.EventManager.OpenThongBaoChon("Lượt chơi này sẽ tốn <color=magenta>"..kcYeuCau.." Kim Cương</color>, bạn có muốn tiếp tục?",
                 function()
                 xacNhanChoiNgay = true 
                 ChoiNgay()
                 end,"Chơi Ngay")
            return
            end
        end
       
        xacNhanChoiNgay = false
        local method = 'MiniGameDapChuot'
        local nameClass = 'ChoiNgay'
        local keyData = { 'key',}
        local valueData = { 'value',}

        local function callback(response)
            local table = _G.LuaExtension:ParseTable(response)
            if table.status == "0" then
                --print('soluotchoi la: '..table.soluotchoi)
                time = 45
                Diem = 0
                Vang = 0
                Exp = 0
                SetDiem()
                isPlay = true
                ObjChuaChoi:SetActive(false)
                ObjDangChoi:SetActive(true)
                soLuotChoi = tonumber(table.soluotchoi)
                SetSoLuotChoi()
                BangKetQua:SetActive(false)
                txtInfo:SetActive(true)
            else
                CS.CrGame.ins:OnThongBaoNhanh(table.message, 2)
            end
                
            print('table status parse: '.. table.status)
        end
        XluaNetwork:SendRequest(method, nameClass, keyData, valueData, callback)
    end
    function SetDiem()
        txtDiem.text = "Điểm: ".. Diem
    end

    function ExitMenu()
        --self.gameObject:SetActive(false)
        CS.AllMenu.ins:DestroyMenu("minigamedapchuot")
    end